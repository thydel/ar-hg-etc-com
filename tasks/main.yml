---

- name: Check if mercurial is installed
  register: hg_installed
  check_mode: False
  changed_when: no
  command: dpkg-query -W -f '${Status}' mercurial

- when: hg_installed.stdout != 'install ok installed'
  debug: { msg: 'Warning, mercurial is not installed' }

- when: hg_installed.stdout == 'install ok installed'
  block:

  - git_config:
      name: user.email
      scope: local
      repo: '{{ playbook_dir }}'
    register: git_config_local
    delegate_to: localhost
    become: False
    name: Get user email from git local config

  - git_config:
      name: user.email
      scope: global
      repo: '{{ playbook_dir }}'
    register: git_config_global
    delegate_to: localhost
    become: False
    name: Get user email from git local config

  - set_fact:
      user_email: git_config_local 
    when: git_config_local is defined

  - set_fact:
      user_email: git_config_global 
    when: user_email is not defined and git_config_global is defined

  - fail: 
      msg: Cant find your git config
    when: user_email is not defined

  - hg_commit:
      cwd: /etc
      com: '{{ com }}'
      user: '{{ user_email }}'
    become: True
    name: Commit /etc changes using mercurial

  - name: Push if requested
    delegate_to: localhost
    register: do_push
    failed_when: do_push.rc > 1
    changed_when: False
    when: push | default(False)
    command: ssh -A {{ ansible_ssh_host | default(inventory_hostname) }} -l root hg --cwd /etc push

  - name: Print last commit id
    debug: { var: hg_commit.id }
    when: show | default(False)
